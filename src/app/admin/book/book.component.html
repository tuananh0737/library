<div class="admin-page-container">
  
  <div class="page-header">
    <div class="header-left">
      <h2>Quản lý Sách</h2>
    </div>
    <div class="header-actions">
      <div class="search-group">
        <i class="bi bi-search"></i>
        <input type="text" placeholder="Tìm tên sách, tác giả..." [(ngModel)]="searchQuery" (input)="performSearch()">
      </div>
      <button class="btn-add-new" (click)="openAddBookForm()">
        <i class="bi bi-plus-lg"></i> Thêm sách mới
      </button>
    </div>
  </div>

  <table class="table table-bordered table-hover">
    <thead class="table-light">
      <tr>
        <th>Tên sách</th>
        <th>Tác giả</th>
        <th>Thể loại</th>
        <th>Số trang</th>
        <th>Năm</th>
        <th>Chi tiết</th>
        <th>Số lượng</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let book of paginatedBooks; trackBy: trackByBookId">
        <td class="fw-bold">{{ book.name }}</td>
        <td>{{ book.author.fullname }}</td>
        <td><span class="badge bg-light text-dark border">{{ book.genres.name }}</span></td>
        <td>{{ book.numberPage }}</td>
        <td>{{ book.publishYear }}</td>
        <td>
          <button class="btn btn-sm btn-info text-white" (click)="showDetails(book)"><i class="bi bi-eye"></i> Xem</button>
        </td>
        <td>{{ book.quantity }}</td>
        <td>
          <div class="action-buttons d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" (click)="openEditBookForm(book)" title="Sửa">
              <i class="bi bi-pencil-square"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" (click)="deleteBook(book.id)" title="Xóa">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="pagination d-flex justify-content-center align-items-center mt-4" *ngIf="totalPages > 1">
    <button class="btn btn-secondary me-2" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
      <i class="bi bi-chevron-left"></i> Trước
    </button>
    <span class="mx-3 fw-bold">Trang {{ currentPage }} / {{ totalPages }}</span>
    <button class="btn btn-secondary ms-2" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">
      Sau <i class="bi bi-chevron-right"></i>
    </button>
  </div>

  <div *ngIf="showDeleteConfirm" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5)">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">Xác nhận xóa</h5>
        </div>
        <div class="modal-body">
          <p>Bạn có chắc chắn muốn xóa sách <strong>{{ selectedBook?.name }}</strong> không?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="cancelDelete()">Hủy</button>
          <button class="btn btn-danger" (click)="confirmDelete()">Xóa ngay</button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="deleteSuccessful" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5)">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center py-4">
          <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
          <h4 class="mt-2">Thành công!</h4>
          <p>Thao tác đã được thực hiện.</p>
          <button class="btn btn-primary mt-2" (click)="cancelDelete()">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade show d-block" *ngIf="selectedBook" style="background: rgba(0,0,0,0.5)">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thông tin chi tiết</h5>
          <button class="btn-close" (click)="closeForm()"></button>
        </div>
        <div class="modal-body">
          <div class="book-details-grid">
             <div class="row mb-2"><div class="col-3 fw-bold">Tên sách:</div><div class="col-9">{{ selectedBook.name }}</div></div>
             <div class="row mb-2"><div class="col-3 fw-bold">Tác giả:</div><div class="col-9">{{ selectedBook.author.fullname }}</div></div>
             <div class="row mb-2"><div class="col-3 fw-bold">Thể loại:</div><div class="col-9">{{ selectedBook.genres.name }}</div></div>
             <div class="row mb-2"><div class="col-3 fw-bold">Năm XB:</div><div class="col-9">{{ selectedBook.publishYear }}</div></div>
             <div class="row mb-2"><div class="col-3 fw-bold">Số lượng:</div><div class="col-9">{{ selectedBook.quantity }}</div></div>
             <div class="row mb-2"><div class="col-3 fw-bold">Vị trí:</div><div class="col-9">Phòng {{ selectedBook.location.room }} - Kệ {{ selectedBook.location.shelf }}</div></div>
             <div class="row mb-2"><div class="col-3 fw-bold">Mô tả:</div><div class="col-9">{{ selectedBook.description }}</div></div>
             <div class="row mb-2" *ngIf="selectedBook.qrCode">
                <div class="col-3 fw-bold">Mã QR:</div>
                <div class="col-9"><img [src]="'data:image/png;base64,' + selectedBook.qrCode" alt="QR Code" style="width: 100px;"/></div>
             </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" (click)="borrow(selectedBook)">Mượn sách</button>
          <button class="btn btn-secondary" (click)="closeForm()">Đóng</button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showBorrowBook" class="modal fade show d-block" style="background: rgba(0,0,0,0.5)">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Mượn sách: {{ selectedBook?.name }}</h5>
          <button class="btn-close" (click)="closeBorrowBookForm()"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Tìm người đọc (Tên, CMND, SĐT)..." [(ngModel)]="userSearchQuery">
            <button class="btn btn-primary" (click)="searchUser()">Tìm</button>
          </div>
          <ul class="list-group" *ngIf="users.length > 0">
              <li *ngFor="let user of users" class="list-group-item list-group-item-action" 
                  [class.active]="selectedUserId === user.id" (click)="selectUser(user.id)" style="cursor: pointer;">
                <strong>{{ user.fullname }}</strong> <br> <small>{{ user.phone }} - {{ user.idCard }}</small>
              </li>
          </ul>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeBorrowBookForm()">Hủy</button>
          <button class="btn btn-primary" (click)="confirmBorrow()">Xác nhận mượn</button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showAddBookForm" class="modal fade show d-block" style="background: rgba(0,0,0,0.5); overflow-y: auto;">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thông tin sách</h5>
          <button class="btn-close" (click)="closeAddBookForm()"></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="saveNewBook()">
            <div class="mb-3">
              <label class="form-label">Tên sách <span class="text-danger">*</span></label>
              <input type="text" class="form-control" [(ngModel)]="newBook.name" name="name" required />
            </div>                
            <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Tác giả <span class="text-danger">*</span></label>
                  <select class="form-select" [(ngModel)]="newBook.author.id" name="author" required>
                    <option *ngFor="let author of authors" [value]="author.id">{{ author.fullname }}</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Thể loại <span class="text-danger">*</span></label>
                  <select class="form-select" [(ngModel)]="newBook.genres.id" name="genre" required>
                    <option *ngFor="let genre of genres" [value]="genre.id">{{ genre.name }}</option>
                  </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Số trang</label>
                  <input type="number" class="form-control" [(ngModel)]="newBook.numberPage" name="pages" required />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Năm phát hành</label>
                  <input type="number" class="form-control" [(ngModel)]="newBook.publishYear" name="year" required />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Số lượng nhập</label>
                  <input type="number" class="form-control" [(ngModel)]="newBook.quantity" name="quantity" required />
                </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Mô tả chi tiết</label>
              <textarea class="form-control" rows="3" [(ngModel)]="newBook.description" name="details"></textarea>
            </div>
            
            <div class="modal-footer px-0 pb-0">
               <button type="button" class="btn btn-secondary" (click)="closeAddBookForm()">Hủy bỏ</button>
               <button type="submit" class="btn btn-success">Lưu thông tin</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>