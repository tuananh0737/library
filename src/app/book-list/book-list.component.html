<div class="book-list-layout">
  <div class="left-column">
    <div class="search-page-container">
      <header class="search-header">
        <div class="header-title">
          <h1>Thư viện</h1>
          <p>Tìm kiếm và khám phá kho sách khổng lồ</p>
        </div>
        
        <div class="filter-toolbar">
          <div class="search-combo-group" style="display: flex; gap: 10px; flex: 1; align-items: center;">
            <select [(ngModel)]="searchType" (change)="onSearch()" class="form-select" style="max-width: 150px; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
              <option value="name">Tên sách</option>
              <option value="author">Tác giả</option>
              <option value="genre">Thể loại</option>
            </select>
        
            <div class="search-input-wrapper" style="position: relative; flex: 1;">
              <i class="bi bi-search" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #888;"></i>
              <input type="text" 
                     [placeholder]="getPlaceholder()" 
                     [(ngModel)]="searchText" 
                     (input)="onSearch()"
                     style="width: 100%; padding: 8px 10px 8px 35px; border-radius: 6px; border: 1px solid #ddd;">
            </div>
          </div>

          <button class="btn-reset" (click)="resetSearch()" title="Xóa bộ lọc">
            <i class="bi bi-arrow-counterclockwise"></i>
          </button>
        </div>
      </header>

      <div class="results-area">
        <div class="book-grid">
          <div class="book-card" *ngFor="let book of paginatedBooks" (click)="onSelectBook(book)"
               [class.active-card]="selectedBook?.id === book.id">
            <div class="card-cover">
              <img [src]="book.image ? book.image : 'https://placehold.co/400x600/e2e8f0/1e293b?text=' + (book.name.charAt(0) | uppercase)" 
                   alt="{{book.name}}"
                   style="object-fit: cover;">
              
              <button class="btn-fav-card" [class.active]="book.isFavorite" (click)="toggleFavorite($event, book)">
                <i class="bi" [ngClass]="book.isFavorite ? 'bi-heart-fill' : 'bi-heart'"></i>
              </button>
              
              <div class="hover-overlay"><span class="overlay-icon"><i class="bi bi-eye-fill"></i></span></div>
            </div>
            <div class="card-info">
              <h3 class="book-title" title="{{book.name}}">{{book.name}}</h3>
              <p class="book-author">{{book.author?.fullname}}</p>
              <div class="book-meta">
                <span class="meta-badge">{{book.genres?.name}}</span>
                <span class="meta-year">{{book.publishYear}}</span>
              </div>
            </div>
          </div>
        </div>
        
        <div *ngIf="filteredBooks.length === 0" class="empty-state">
           <div class="empty-icon"><i class="bi bi-search"></i></div>
           <h3>Không tìm thấy kết quả</h3>
        </div>

        <div class="pagination-container d-flex justify-content-center mt-5 mb-5" *ngIf="totalPages > 1">
            <nav>
              <ul class="pagination shadow-sm">
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <button class="page-link border-0" (click)="goToPage(currentPage - 1)">
                    <i class="bi bi-chevron-left"></i> Trước
                  </button>
                </li>
                <li class="page-item active" aria-current="page">
                  <span class="page-link border-0 bg-primary">{{ currentPage }} / {{ totalPages }}</span>
                </li>
                <li class="page-item" [class.disabled]="currentPage === totalPages">
                  <button class="page-link border-0" (click)="goToPage(currentPage + 1)">
                    Sau <i class="bi bi-chevron-right"></i>
                  </button>
                </li>
              </ul>
            </nav>
        </div>

      </div>
    </div>
  </div>

  <aside class="right-panel" *ngIf="selectedBook">
    <div class="panel-header">
      <span class="panel-label">Thông tin chi tiết</span>
      <button class="btn-close-panel" (click)="closeDetail()"><i class="bi bi-x-lg"></i></button>
    </div>

    <div class="panel-content">
      <div class="book-preview-large">
        <div class="large-cover">
          <img [src]="selectedBook.image ? selectedBook.image : 'https://placehold.co/400x600/e2e8f0/1e293b?text=' + (selectedBook.name.charAt(0) | uppercase)" 
               alt="{{selectedBook.name}}"
               style="object-fit: cover;">
        </div>
        <div class="title-row">
          <h2 class="detail-title">{{selectedBook.name}}</h2>
          <button class="btn-fav-panel" [class.active]="selectedBook.isFavorite" (click)="toggleFavorite($event, selectedBook)">
            <i class="bi" [ngClass]="selectedBook.isFavorite ? 'bi-heart-fill' : 'bi-heart'"></i>
          </button>
        </div>
        <p class="detail-author">bởi <span>{{selectedBook.author?.fullname}}</span></p>
      </div>

      <div class="detail-section">
        <h3>Giới thiệu</h3>
        <p class="description-text">{{selectedBook.description || 'Chưa có mô tả.'}}</p>
      </div>

      <div class="detail-stats">
         <div class="stat-box"><span class="stat-val">{{selectedBook.quantity}}</span><span class="stat-lbl">Còn lại</span></div>
         <div class="stat-box"><span class="stat-val">{{selectedBook.location?.room}}</span><span class="stat-lbl">Phòng</span></div>
         <div class="stat-box"><span class="stat-val">{{selectedBook.location?.shelf}}</span><span class="stat-lbl">Kệ</span></div>
      </div>

      <div class="detail-section comments-area">
        <div class="section-header">
          <h3>Đánh giá & Bình luận</h3>
          <button class="btn-open-review" (click)="openReviewForm()">
            <i class="bi bi-pencil-square"></i> Viết đánh giá
          </button>
        </div>
        
        <div class="comment-list">
          <div class="comment-item" *ngFor="let c of comments">
            <div class="comment-avatar">{{c.user.charAt(0) | uppercase}}</div>
            <div class="comment-body">
              <div class="comment-header">
                <div class="user-info-group">
                  <span class="comment-user">{{c.user}}</span>
                  <div class="small-stars">
                    <i *ngFor="let s of [1,2,3,4,5]" class="bi bi-star-fill" [class.active-star]="s <= c.rating"></i>
                  </div>
                </div>
                <button class="btn-delete-cmt" *ngIf="c.isCurrentUser" (click)="deleteComment(c)" title="Xóa">
                  <i class="bi bi-trash"></i>
                </button>
                </div>
              <span class="comment-date">{{c.date | date:'dd/MM/yyyy HH:mm'}}</span>
              <p class="comment-content">{{c.content}}</p>
            </div>
          </div>
          <div *ngIf="comments.length === 0" class="no-comments">
            Chưa có đánh giá nào. Hãy là người đầu tiên!
          </div>
        </div>
      </div>
    </div>
  </aside>

  <div class="review-modal-overlay" *ngIf="showReviewModal">
    <div class="review-modal">
      <div class="modal-header">
        <h3>Đánh giá sách</h3>
        <button class="btn-close-modal" (click)="closeReviewForm()"><i class="bi bi-x"></i></button>
      </div>
      <div class="modal-body">
        <p class="book-name-review">Bạn cảm thấy thế nào về cuốn sách <b>"{{selectedBook?.name}}"</b>?</p>
        <div class="star-rating-select">
          <i *ngFor="let star of [1,2,3,4,5]" 
             class="bi" 
             [ngClass]="star <= (tempHoverRating || tempRating) ? 'bi-star-fill' : 'bi-star'"
             (mouseenter)="tempHoverRating = star"
             (mouseleave)="tempHoverRating = 0"
             (click)="setRating(star)"></i>
        </div>
        <textarea class="review-textarea" placeholder="Hãy chia sẻ cảm nhận của bạn..." rows="4" [(ngModel)]="tempComment"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeReviewForm()">Hủy bỏ</button>
        <button class="btn-submit" (click)="submitReview()">Gửi đánh giá</button>
      </div>
    </div>
  </div>
</div>